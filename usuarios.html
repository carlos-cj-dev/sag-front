<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuários - SAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/pagination.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="min-h-screen flex flex-col">
        <!-- Navbar -->
        <nav class="bg-blue-600 text-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center">
                            <span class="text-xl font-bold">SAG</span>
                        </div>
                        <div class="hidden md:ml-6 md:flex md:items-center md:space-x-4">
                            <a href="dashboard.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Dashboard</a>
                            <a href="escolas.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Escolas</a>
                            <a href="turmas.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Turmas</a>
                            <a href="alunos.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Alunos</a>
                            <a href="provas.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Provas</a>
                            <a href="usuarios.html" class="px-3 py-2 rounded-md text-sm font-medium bg-blue-700">Usuários</a>
                            <a href="gabaritos_geracao.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Gabaritos</a>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span id="userNameDisplay" class="mr-4"></span>
                        <button id="logoutBtn" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                            <i class="fas fa-sign-out-alt mr-1"></i> Sair
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mobile menu -->
            <div class="md:hidden hidden" id="mobileMenu">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="dashboard.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Dashboard</a>
                    <a href="escolas.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Escolas</a>
                    <a href="turmas.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Turmas</a>
                    <a href="alunos.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Alunos</a>
                    <a href="provas.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Provas</a>
                    <a href="usuarios.html" class="block px-3 py-2 rounded-md text-base font-medium bg-blue-700">Usuários</a>
                    <a href="gabaritos_geracao.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Gabaritos</a>
                    <a href="gabaritos_correcao.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Correção</a>
                </div>
            </div>
        </nav>
        
        <!-- Main content -->
        <main class="flex-grow">
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <!-- Page header -->
                <div class="px-4 py-5 sm:px-6 bg-white shadow rounded-lg mb-6 flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Usuários</h1>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">Gerenciamento de usuários do sistema</p>
                    </div>
                    <button id="addUserBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-plus mr-2"></i> Novo Usuário
                    </button>
                </div>
                
                <!-- Users List -->
                <div class="bg-white shadow overflow-hidden sm:rounded-md">
                    <ul id="usersList" class="divide-y divide-gray-200 overflow-hidden">
                        <li class="px-4 py-4 sm:px-6 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i> Carregando usuários...
                        </li>
                    </ul>
                </div>
                
                <!-- Pagination Controls -->
                <div id="usersPaginationControls" class="px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 hidden">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="usersPrevPageMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Anterior
                        </button>
                        <div class="text-sm text-gray-700 py-2">
                            <span id="usersCurrentPageMobile">1</span>
                        </div>
                        <button id="usersNextPageMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Próxima
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Mostrando <span id="usersStartItem" class="font-medium">1</span> a <span id="usersEndItem" class="font-medium">10</span> de <span id="usersTotalItems" class="font-medium">0</span> usuários
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                <button id="usersPrevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">Anterior</span>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div id="usersPaginationContainer" class="flex">
                                    <!-- Page buttons will be inserted here -->
                                </div>
                                <button id="usersNextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">Próxima</span>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="bg-white">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                <p class="text-center text-sm text-gray-500">SAG - Sistema de Avaliação e Gerenciamento © 2023</p>
            </div>
        </footer>
        
        <!-- Add User Modal -->
        <div id="addUserModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Adicionar Novo Usuário</h3>
                    <button id="closeUserModal" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="addUserForm" class="space-y-4">
                    <div>
                        <label for="userName" class="block text-sm font-medium text-gray-700">Nome</label>
                        <input type="text" id="userName" name="userName" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="userEmail" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="userEmail" name="userEmail" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="userPassword" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input type="password" id="userPassword" name="userPassword" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="userType" class="block text-sm font-medium text-gray-700">Tipo de Usuário</label>
                        <select id="userType" name="userType" required
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">Selecione o tipo</option>
                            <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                            <option value="COORDENADOR">COORDENADOR</option>
                            <option value="PROFESSOR">PROFESSOR</option>
                            <option value="GESTOR">GESTOR</option>
                            <option value="SECRETARIA">SECRETARIA</option>
                        </select>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="cancelUserBtn" class="mr-3 bg-gray-200 px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                            Cancelar
                        </button>
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Edit User Modal -->
        <div id="editUserModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Editar Usuário</h3>
                    <button id="closeEditUserModal" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="editUserForm" class="space-y-4">
                    <input type="hidden" id="editUserId">
                    <input type="hidden" id="editUserApiId">
                    <div>
                        <label for="editUserName" class="block text-sm font-medium text-gray-700">Nome</label>
                        <input type="text" id="editUserName" name="editUserName" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="editUserEmail" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="editUserEmail" name="editUserEmail" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="editUserPassword" class="block text-sm font-medium text-gray-700">Nova Senha (deixe em branco para manter a atual)</label>
                        <input type="password" id="editUserPassword" name="editUserPassword"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="editUserType" class="block text-sm font-medium text-gray-700">Tipo de Usuário</label>
                        <select id="editUserType" name="editUserType" required
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">Selecione o tipo</option>
                            <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                            <option value="COORDENADOR">COORDENADOR</option>
                            <option value="PROFESSOR">PROFESSOR</option>
                            <option value="GESTOR">GESTOR</option>
                            <option value="SECRETARIA">SECRETARIA</option>
                        </select>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="cancelEditUserBtn" class="mr-3 bg-gray-200 px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                            Cancelar
                        </button>
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Atualizar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="js/app.js"></script>
    <script src="js/alert.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar lista de usuários se não existir
            if (!localStorage.getItem('users')) {
                localStorage.setItem('users', JSON.stringify([]));
            }
            
            // Verificar se o usuário atual é administrador
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('userNameDisplay').textContent = currentUser.name;
                
                // Usar a função isAdmin do app.js para verificar se é administrador
                const isAdminUser = isAdmin(currentUser);
                console.log('Verificação de administrador:', isAdminUser);
                
                // Se não for admin, redirecionar para dashboard
                if (!isAdminUser) {
                    showAlert('warning', 'Acesso Restrito', 'Apenas administradores podem acessar esta página.', 3000, function() {
                        window.location.href = 'dashboard.html';
                    });
                    return; // Impedir a execução do resto do código
                }
            }
            
            // Carregar usuários da API
            loadUsersFromAPI();
            
            // Eventos dos modais
            const addUserBtn = document.getElementById('addUserBtn');
            const addUserModal = document.getElementById('addUserModal');
            const closeUserModal = document.getElementById('closeUserModal');
            const cancelUserBtn = document.getElementById('cancelUserBtn');
            const addUserForm = document.getElementById('addUserForm');
            
            // Configurar eventos para modal de edição
            const editUserModal = document.getElementById('editUserModal');
            const closeEditUserModal = document.getElementById('closeEditUserModal');
            const cancelEditUserBtn = document.getElementById('cancelEditUserBtn');
            const editUserForm = document.getElementById('editUserForm');
            
            // Configurar eventos para fechar o modal de edição
            if (closeEditUserModal) {
                closeEditUserModal.addEventListener('click', function() {
                    editUserModal.classList.add('hidden');
                });
            }
            
            if (cancelEditUserBtn) {
                cancelEditUserBtn.addEventListener('click', function() {
                    editUserModal.classList.add('hidden');
                });
            }
            
            // Configurar evento de envio do formulário de edição
            if (editUserForm) {
                editUserForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const userId = document.getElementById('editUserId').value;
                    const apiId = document.getElementById('editUserApiId').value;
                    const name = document.getElementById('editUserName').value;
                    const email = document.getElementById('editUserEmail').value;
                    const password = document.getElementById('editUserPassword').value;
                    const type = document.getElementById('editUserType').value;
                    
                    if (name && name.trim() !== '' && email && email.trim() !== '' && type) {
                        try {
                            updateUserAPI(userId, apiId, name, email, password, type);
                        } catch (error) {
                            console.error('Erro ao atualizar usuário:', error);
                            showAlert('error', 'Erro', 'Ocorreu um erro ao atualizar o usuário: ' + error.message);
                        }
                    } else {
                        showAlert('error', 'Erro', 'Por favor, preencha todos os campos obrigatórios.');
                    }
                });
            }
            
            addUserBtn.addEventListener('click', function() {
                // Reset form fields before showing the modal
                document.getElementById('userName').value = '';
                document.getElementById('userEmail').value = '';
                document.getElementById('userPassword').value = '';
                document.getElementById('userType').selectedIndex = 0;
                
                // Show the modal
                addUserModal.classList.remove('hidden');
            });
            
            closeUserModal.addEventListener('click', function() {
                addUserModal.classList.add('hidden');
            });
            
            cancelUserBtn.addEventListener('click', function() {
                addUserModal.classList.add('hidden');
            });
            
            addUserForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Formulário submetido');
                
                // Verificar todos os elementos do formulário
                const userNameInput = document.getElementById('userName');
                const userEmailInput = document.getElementById('userEmail');
                const userPasswordInput = document.getElementById('userPassword');
                const userTypeInput = document.getElementById('userType');
                
                console.log('Elementos do formulário:', { 
                    userNameInput, 
                    userEmailInput, 
                    userPasswordInput, 
                    userTypeInput 
                });
                
                // Corrigir a captura dos valores
                const nome = userNameInput ? userNameInput.value : "Usuário";
                const email = userEmailInput ? userEmailInput.value : "";
                const senha = userPasswordInput ? userPasswordInput.value : "";
                const tipo_usuario = userTypeInput ? userTypeInput.value : "";
                
                console.log('Valores capturados:', { nome, email, senha, tipo_usuario });
                
                if (nome && nome.trim() !== '' && email && email.trim() !== '' && senha && senha.trim() !== '' && tipo_usuario) {
                    try {
                        // Verificar se a função getUsers existe
                        if (typeof getUsers !== 'function') {
                            console.error('Função getUsers não encontrada. Verifique se o arquivo app.js está carregado corretamente.');
                            alert('Erro interno: Função getUsers não encontrada');
                            return;
                        }
                        
                        // Verificar se o email já existe
                        const users = getUsers();
                        console.log('Usuários existentes:', users);
                        
                        const emailExists = users.some(user => user.email === email);
                        
                        if (emailExists) {
                            showAlert('error', 'Erro', 'Este email já está em uso. Por favor, escolha outro.');
                            return;
                        }
                        
                        console.log('Chamando registerUserAPI');
                        // Integração com a API - Enviar dados para registro
                        registerUserAPI(nome, email, senha, tipo_usuario);
                    } catch (error) {
                        console.error('Erro ao verificar usuários:', error);
                        showAlert('error', 'Erro', 'Ocorreu um erro ao verificar usuários existentes: ' + error.message);
                    }
                } else {
                    showAlert('error', 'Erro', 'Por favor, preencha todos os campos obrigatórios.');
                }
            });
        });
        
        // Variable to store the pagination controller
        let usersPagination = null;

        // Modified function to render users list with pagination
        function renderUsersList() {
            const usersList = document.getElementById('usersList');
            const users = getUsers();
            
            // Se não houver usuários, mostrar mensagem
            if (users.length === 0) {
                usersList.innerHTML = `
                    <li class="px-4 py-4 sm:px-6 text-center text-gray-500">
                        Nenhum usuário cadastrado
                    </li>`;
                document.getElementById('usersPaginationControls').classList.add('hidden');
                return;
            }
            
            // Show pagination controls
            document.getElementById('usersPaginationControls').classList.remove('hidden');
            
            // Initialize pagination if not already done
            if (!usersPagination) {
                initUsersPagination(users);
            } else {
                usersPagination.updateData(users);
            }
        }
        
        // Function to initialize pagination for users
        function initUsersPagination(users) {
            usersPagination = createPagination({
                data: users,
                itemsPerPage: 10,
                renderItemCallback: (container, user, startIndex) => {
                    const li = document.createElement('li');
                    li.className = 'block hover:bg-gray-50';
                    
                    // Format role for display
                    let roleDisplay = translateRole(user.type);
                    let roleClass = "";
                    
                    if (user.type === 'ADMINISTRADOR') {
                        roleClass = "bg-red-100 text-red-800";
                    } else if (user.type === 'COORDENADOR') {
                        roleClass = "bg-yellow-100 text-yellow-800";
                    } else {
                        roleClass = "bg-green-100 text-green-800";
                    }
                    
                    li.innerHTML = `
                        <div class="flex items-center px-4 py-4 sm:px-6">
                            <div class="min-w-0 flex-1 flex items-center">
                                <div class="flex-shrink-0">
                                    <span class="h-12 w-12 rounded-full bg-indigo-100 flex items-center justify-center">
                                        <i class="fas fa-user text-indigo-600 text-lg"></i>
                                    </span>
                                </div>
                                <div class="min-w-0 flex-1 px-4">
                                    <div>
                                        <p class="text-sm font-medium text-blue-600 truncate">${user.name}</p>
                                        <p class="mt-1 text-sm text-gray-500">
                                            Email: ${user.email}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${roleClass} ml-2">
                                                ${roleDisplay}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button class="text-indigo-600 hover:text-indigo-900 editUser" data-id="${user.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="ml-4 text-red-600 hover:text-red-900 deleteUser" data-id="${user.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(li);
                },
                containerSelector: '#usersList',
                paginationContainerSelector: '#usersPaginationContainer',
                emptyCallback: (container) => {
                    container.innerHTML = `
                        <li class="px-4 py-4 sm:px-6 text-center text-gray-500">
                            Nenhum usuário cadastrado
                        </li>`;
                },
                countElements: {
                    start: document.getElementById('usersStartItem'),
                    end: document.getElementById('usersEndItem'),
                    total: document.getElementById('usersTotalItems')
                },
                prevBtnSelector: '#usersPrevPage',
                nextBtnSelector: '#usersNextPage',
                prevBtnMobileSelector: '#usersPrevPageMobile',
                nextBtnMobileSelector: '#usersNextPageMobile'
            });
            
            // Render the pagination
            usersPagination.render();
            
            // Add event handlers for the edit and delete buttons
            document.querySelectorAll('.editUser').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    openEditUserModal(userId);
                });
            });
            
            document.querySelectorAll('.deleteUser').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    deleteUser(userId);
                });
            });
        }
        
        // Helper function to translate role to display text
        function translateRole(role) {
            const roleMap = {
                'ADMINISTRADOR': 'Administrador',
                'COORDENADOR': 'Coordenador',
                'PROFESSOR': 'Professor',
                'GESTOR': 'Gestor',
                'SECRETARIA': 'Secretaria'
            };
            
            return roleMap[role] || role;
        }
        
        // Nova função para carregar usuários da API
        async function loadUsersFromAPI() {
            try {
                // Mostrar mensagem de carregamento
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = `
                    <li class="px-4 py-4 sm:px-6 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i> Carregando usuários da API...
                    </li>`;
                
                const response = await fetch('https://sag-sag.rak8a3.easypanel.host/api/usuarios', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Status da resposta da listagem de usuários:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Erro ao carregar usuários. Status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Usuários recebidos da API:', data);
                
                // Limpar usuários locais existentes
                let localUsers = getUsers();
                // Manter apenas o usuário admin local (id: 1) para garantir acesso
                localUsers = localUsers.filter(user => user.id === 1);
                
                // Adicionar usuários da API à lista local
                if (Array.isArray(data)) {
                    data.forEach(user => {
                        // Verificar se já existe um usuário com este API ID
                        const existingUser = localUsers.find(u => u.apiId === user.id);
                        
                        if (!existingUser) {
                            // Adicionar um novo usuário
                            localUsers.push({
                                id: localUsers.length > 0 ? Math.max(...localUsers.map(u => u.id)) + 1 : 1,
                                email: user.email,
                                password: '******', // Não temos a senha do usuário
                                type: user.tipo_usuario || 'USUARIO',
                                name: user.nome || 'Usuário',
                                apiId: user.id
                            });
                        }
                    });
                    
                    // Salvar a lista atualizada
                    localStorage.setItem('users', JSON.stringify(localUsers));
                }
                
                // Renderizar a lista de usuários
                renderUsersList();
                
            } catch (error) {
                console.error('Erro ao carregar usuários da API:', error);
                
                // Mostrar mensagem de erro ao usuário
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = `
                    <li class="px-4 py-4 sm:px-6 text-center text-red-500">
                        Erro ao carregar usuários da API. Usando dados locais.
                    </li>`;
                
                // Carregar dados locais como fallback
                setTimeout(() => {
                    renderUsersList();
                }, 1500);
            }
        }
        
        // Função para cadastrar usuário via API
        async function registerUserAPI(nome, email, senha, tipo_usuario) {
            try {
                // Garantir que o nome é uma string válida
                const nomeValido = nome && typeof nome === 'string' ? nome : "Usuário";
                
                // Exibir indicador de carregamento
                const submitBtn = document.querySelector('#addUserForm button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
                submitBtn.disabled = true;
                
                // Preparar payload no formato correto que a API espera
                const payload = {
                    nome: nomeValido,
                    email: email,
                    senha: senha,
                    tipo_usuario: tipo_usuario // Já está no formato correto do enum (ADMINISTRADOR, etc.)
                };
                
                console.log('Enviando dados para API:', payload);
                
                const response = await fetch('https://sag-sag.rak8a3.easypanel.host/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                // Restaurar botão
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
                
                console.log('Status da resposta:', response.status);
                
                // Log da resposta completa para debug
                const responseText = await response.text();
                console.log('Resposta da API:', responseText);
                
                // Tentar converter para JSON se possível
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.log('Resposta não é um JSON válido');
                }
                
                if (response.ok) {
                    console.log('Usuário registrado com sucesso:', data);
                    
                    // Adicionar o usuário recebido da API à lista local
                    // Formato da resposta: { id: 0, nome: "string", email: "user@example.com", tipo_usuario: "ADMINISTRADOR" }
                    const usuario = {
                        email: data?.email || email,
                        senha: senha, // A API não retorna a senha
                        tipo_usuario: data?.tipo_usuario || tipo_usuario,
                        nome: data?.nome || nomeValido,
                        apiId: data?.id
                    };
                    
                    addUser(usuario.email, usuario.senha, usuario.tipo_usuario, usuario.nome, usuario.apiId);
                    
                    // Atualizar a lista de usuários
                    renderUsersList();
                    
                    // Fechar o modal e resetar o formulário
                    document.getElementById('addUserModal').classList.add('hidden');
                    document.getElementById('addUserForm').reset();
                    
                    // Mostrar mensagem de sucesso
                    showAlert('success', 'Usuário Cadastrado', 'Usuário cadastrado com sucesso!');
                } else {
                    const errorMessage = data ? data.message || 'Erro ao registrar usuário.' : 'Erro ao registrar usuário.';
                    showAlert('error', 'Erro', errorMessage);
                }
            } catch (error) {
                console.error('Erro ao registrar usuário:', error);
                showAlert('error', 'Erro', 'Ocorreu um erro ao tentar registrar o usuário: ' + error.message);
            } finally {
                // Restaurar botão
                const submitBtn = document.querySelector('#addUserForm button[type="submit"]');
                submitBtn.innerHTML = 'Salvar';
                submitBtn.disabled = false;
            }
        }
        
        // Modificar a função addUser para aceitar um ID da API
        function addUser(email, senha, tipo_usuario, nome, apiId = null) {
            let users = getUsers();
            const newId = apiId || (users.length > 0 ? Math.max(...users.map(user => user.id)) + 1 : 1);
            
            // Garantir que o nome é uma string válida
            const nomeValido = nome && typeof nome === 'string' ? nome : "Usuário";
            
            const newUser = {
                id: newId,
                email: email,
                password: senha,
                type: tipo_usuario,
                name: nomeValido,
                apiId: apiId
            };
            
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            return newUser;
        }
        
        // Função para excluir um usuário
        function deleteUser(id) {
            // Procurar usuário no armazenamento local
            let users = JSON.parse(localStorage.getItem('users'));
            const userToDelete = users.find(user => user.id === id);
            
            if (!userToDelete) {
                showAlert('error', 'Erro', 'Usuário não encontrado.');
                return;
            }
            
            // Se o usuário tiver um ID da API, tentar excluir na API primeiro
            if (userToDelete.apiId) {
                // Usar a função showDeleteConfirm para pedir confirmação
                showDeleteConfirm(
                    'Confirmar exclusão', 
                    'Tem certeza que deseja excluir este usuário?', 
                    function() {
                        // Função executada ao confirmar
                        deleteUserAPI(userToDelete.apiId, id);
                    }
                );
            } else {
                // Não tem ID da API, então apenas exclui localmente
                users = users.filter(user => user.id !== id);
                localStorage.setItem('users', JSON.stringify(users));
                renderUsersList();
                showAlert('success', 'Sucesso', 'Usuário excluído com sucesso!');
            }
        }
        
        // Função para excluir usuário na API
        async function deleteUserAPI(apiId, localId) {
            try {
                console.log(`Tentando excluir usuário com API ID: ${apiId}, Local ID: ${localId}`);
                
                const response = await fetch(`https://sag-sag.rak8a3.easypanel.host/api/usuarios/${apiId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Status da resposta de exclusão:', response.status);
                
                // Log da resposta completa para debug
                const responseText = await response.text();
                console.log('Resposta da API (exclusão):', responseText);
                
                // Tentar converter para JSON se possível
                let data;
                try {
                    if (responseText) {
                        data = JSON.parse(responseText);
                    }
                } catch (e) {
                    console.log('Resposta não é um JSON válido');
                }
                
                if (response.ok) {
                    // Excluir localmente após sucesso na API
                    let users = JSON.parse(localStorage.getItem('users'));
                    users = users.filter(user => user.id !== localId);
                    localStorage.setItem('users', JSON.stringify(users));
                    renderUsersList();
                    showAlert('success', 'Sucesso', 'Usuário excluído com sucesso!');
                } else {
                    const errorMessage = data ? data.message || 'Erro ao excluir usuário.' : 'Erro ao excluir usuário.';
                    showAlert('error', 'Erro', errorMessage);
                }
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                showAlert('error', 'Erro', 'Ocorreu um erro ao tentar excluir o usuário: ' + error.message);
            }
        }
        
        // Função para obter usuários
        function getUsers() {
            try {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                return users;
            } catch (error) {
                console.error('Erro ao obter usuários:', error);
                return [];
            }
        }
        
        // Função para mostrar o modal de sucesso
        function showSuccessModal(title, message, callback = null) {
            // Definir título e mensagem
            document.getElementById('successModalTitle').textContent = title || 'Operação Concluída';
            document.getElementById('successModalMessage').textContent = message || 'Operação realizada com sucesso!';
            
            // Mostrar o modal
            document.getElementById('successModal').classList.remove('hidden');
            
            // Configurar evento do botão OK
            const okBtn = document.getElementById('successModalOkBtn');
            
            // Remover listeners anteriores
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            // Adicionar novo listener
            newOkBtn.addEventListener('click', function() {
                document.getElementById('successModal').classList.add('hidden');
                if (typeof callback === 'function') {
                    callback();
                }
            });
            
            // Configurar evento do botão de fechar
            const closeBtn = document.getElementById('closeSuccessModal');
            
            // Remover listeners anteriores
            const newCloseBtn = closeBtn.cloneNode(true);
            closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
            
            // Adicionar novo listener
            newCloseBtn.addEventListener('click', function() {
                document.getElementById('successModal').classList.add('hidden');
                if (typeof callback === 'function') {
                    callback();
                }
            });
        }
        
        // Função para abrir o modal de edição de usuário
        function openEditUserModal(userId) {
            const users = getUsers();
            const user = users.find(u => u.id === userId);
            
            if (!user) {
                showAlert('error', 'Erro', 'Usuário não encontrado!');
                return;
            }
            
            // Preencher o formulário com os dados do usuário
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserApiId').value = user.apiId || '';
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserEmail').value = user.email || '';
            document.getElementById('editUserPassword').value = ''; // Sempre vazio por segurança
            
            // Selecionar o tipo correto de usuário
            const selectElement = document.getElementById('editUserType');
            
            // Verificar opções disponíveis
            for (let i = 0; i < selectElement.options.length; i++) {
                // Comparação insensível a maiúsculas/minúsculas
                if (selectElement.options[i].value.toLowerCase() === (user.type || '').toLowerCase()) {
                    selectElement.selectedIndex = i;
                    break;
                }
            }
            
            // Mostrar o modal
            document.getElementById('editUserModal').classList.remove('hidden');
        }
        
        // Função para atualizar usuário via API
        async function updateUserAPI(userId, apiId, nome, email, senha, tipo_usuario) {
            try {
                // Exibir indicador de carregamento
                const submitBtn = document.querySelector('#editUserForm button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
                submitBtn.disabled = true;
                
                // Verificar se temos o ID da API
                if (!apiId) {
                    console.error('Erro: ID da API não encontrado');
                    showAlert('error', 'Erro', 'Não foi possível editar este usuário. ID da API não encontrado.');
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                    return;
                }
                
                // Preparar payload - incluindo senha apenas se fornecida
                const payload = {
                    nome: nome,
                    email: email,
                    tipo_usuario: tipo_usuario
                };
                
                // Adicionar senha ao payload apenas se foi fornecida
                if (senha && senha.trim() !== '') {
                    payload.senha = senha;
                }
                
                console.log('Enviando dados para API:', payload);
                
                // Usar o endpoint correto
                const response = await fetch(`https://sag-sag.rak8a3.easypanel.host/api/usuarios/${apiId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                // Log da resposta completa
                const responseText = await response.text();
                console.log('Resposta da API (atualização):', responseText);
                
                // Tentar converter para JSON se possível
                let data;
                try {
                    if (responseText) {
                        data = JSON.parse(responseText);
                    }
                } catch (e) {
                    console.log('Resposta não é um JSON válido');
                }
                
                if (response.ok) {
                    // Atualizar usuário no localStorage
                    const users = getUsers();
                    const index = users.findIndex(u => u.id === parseInt(userId));
                    
                    if (index !== -1) {
                        users[index].name = nome;
                        users[index].email = email;
                        users[index].type = tipo_usuario;
                        // Não atualizar a senha local
                        
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                    
                    // Fechar o modal
                    document.getElementById('editUserModal').classList.add('hidden');
                    
                    // Atualizar a lista de usuários
                    renderUsersList();
                    
                    // Mostrar mensagem de sucesso
                    showAlert('success', 'Usuário Atualizado', 'Usuário atualizado com sucesso!');
                } else {
                    const errorMessage = data ? data.message || 'Erro ao atualizar usuário.' : 'Erro ao atualizar usuário.';
                    showAlert('error', 'Erro', errorMessage);
                }
            } catch (error) {
                console.error('Erro ao atualizar usuário:', error);
                showAlert('error', 'Erro', 'Ocorreu um erro ao tentar atualizar o usuário: ' + error.message);
            } finally {
                // Restaurar botão
                const submitBtn = document.querySelector('#editUserForm button[type="submit"]');
                submitBtn.innerHTML = 'Atualizar';
                submitBtn.disabled = false;
            }
        }
    </script>
</body>
</html> 