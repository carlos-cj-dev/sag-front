<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alunos - SAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/pagination.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="min-h-screen flex flex-col">
        <!-- Navbar -->
        <nav class="bg-blue-600 text-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center">
                            <span class="text-xl font-bold">SAG</span>
                        </div>
                        <div class="hidden md:ml-6 md:flex md:items-center md:space-x-4">
                            <a href="dashboard.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Dashboard</a>
                            <a href="escolas.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Escolas</a>
                            <a href="turmas.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Turmas</a>
                            <a href="alunos.html" class="px-3 py-2 rounded-md text-sm font-medium bg-blue-700">Alunos</a>
                            <a href="provas.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Provas</a>
                            <a href="usuarios.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Usuários</a>
                            <a href="gabaritos_geracao.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Gabaritos</a>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span id="userName" class="mr-4"></span>
                        <button id="logoutBtn" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                            <i class="fas fa-sign-out-alt mr-1"></i> Sair
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mobile menu -->
            <div class="md:hidden hidden" id="mobileMenu">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="dashboard.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Dashboard</a>
                    <a href="escolas.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Escolas</a>
                    <a href="turmas.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Turmas</a>
                    <a href="alunos.html" class="block px-3 py-2 rounded-md text-base font-medium bg-blue-700">Alunos</a>
                    <a href="provas.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Provas</a>
                    <a href="usuarios.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Usuários</a>
                    <a href="gabaritos_geracao.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Gabaritos</a>
                    <a href="gabaritos_correcao.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Correção</a>
                </div>
            </div>
        </nav>
        
        <!-- Main content -->
        <main class="flex-grow">
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <!-- Page header -->
                <div class="px-4 py-5 sm:px-6 bg-white shadow rounded-lg mb-6 flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Alunos</h1>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">Gerenciamento de alunos</p>
                    </div>
                    <button id="addStudentBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-plus mr-2"></i> Adicionar Aluno
                    </button>
                </div>
                
                <!-- Filter section -->
                <div class="bg-white shadow px-4 py-5 sm:px-6 rounded-lg mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="filterSchool" class="block text-sm font-medium text-gray-700">Filtrar por Escola</label>
                            <select id="filterSchool" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="">Todas as escolas</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterClass" class="block text-sm font-medium text-gray-700">Filtrar por Turma</label>
                            <select id="filterClass" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="">Todas as turmas</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Students List -->
                <div class="bg-white shadow overflow-hidden sm:rounded-md">
                    <ul id="studentsList" class="divide-y divide-gray-200 overflow-hidden">
                        <li class="px-4 py-4 sm:px-6 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i> Carregando alunos...
                        </li>
                    </ul>
                    
                    <!-- Pagination Controls -->
                    <div id="studentsPaginationControls" class="px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 hidden">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button id="studentsPrevPageMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Anterior
                            </button>
                            <div class="text-sm text-gray-700 py-2">
                                <span id="studentsCurrentPageMobile">1</span>
                            </div>
                            <button id="studentsNextPageMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Próxima
                            </button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div>
                                <p class="text-sm text-gray-700">
                                    Mostrando <span id="studentsStartItem" class="font-medium">1</span> a <span id="studentsEndItem" class="font-medium">10</span> de <span id="studentsTotalItems" class="font-medium">0</span> alunos
                                </p>
                            </div>
                            <div>
                                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                    <button id="studentsPrevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        <span class="sr-only">Anterior</span>
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div id="studentsPaginationContainer" class="flex">
                                        <!-- Page buttons will be inserted here -->
                                    </div>
                                    <button id="studentsNextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        <span class="sr-only">Próxima</span>
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="bg-white">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                <p class="text-center text-sm text-gray-500">SAG - Sistema de Avaliação e Gerenciamento © 2023</p>
            </div>
        </footer>
        
        <!-- Add Student Modal -->
        <div id="addStudentModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Adicionar Novo Aluno</h3>
                    <button id="closeStudentModal" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="addStudentForm" class="space-y-4">
                    <div>
                        <label for="studentName" class="block text-sm font-medium text-gray-700">Nome do Aluno</label>
                        <input type="text" id="studentName" name="studentName" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="studentRegistration" class="block text-sm font-medium text-gray-700">Matrícula</label>
                        <input type="number" id="studentRegistration" name="studentRegistration" min="1" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="studentSchool" class="block text-sm font-medium text-gray-700">Escola</label>
                        <select id="studentSchool" name="studentSchool" required
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">Selecione uma escola</option>
                        </select>
                    </div>
                    <div>
                        <label for="studentClass" class="block text-sm font-medium text-gray-700">Turma</label>
                        <select id="studentClass" name="studentClass" required
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">Selecione uma turma</option>
                        </select>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="cancelStudentBtn" class="mr-3 bg-gray-200 px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                            Cancelar
                        </button>
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="js/app.js"></script>
    <script>
        // Helper function to ensure all IDs are treated as numbers
        function ensureNumber(value) {
            if (value === null || value === undefined) return null;
            return Number(value);
        }
        
        // Improved function for filtering students
        function getStudents(schoolId = null, classId = null) {
            // Converter IDs para números para garantir consistência
            schoolId = ensureNumber(schoolId);
            classId = ensureNumber(classId);
            
            const students = JSON.parse(localStorage.getItem('students')) || [];
            console.log(`Função getStudents chamada com: schoolId=${schoolId}, classId=${classId}`);
            console.log(`Total de alunos no sistema: ${students.length}`);
            
            // If no filters are applied, return all students
            if (!schoolId && !classId) {
                console.log('Nenhum filtro aplicado, retornando todos os alunos');
                return students;
            }
            
            // Filter by school ID only
            if (schoolId && !classId) {
                const filtered = students.filter(student => ensureNumber(student.schoolId) === schoolId);
                console.log(`Filtrando apenas por escola ID=${schoolId}, encontrados ${filtered.length} alunos`);
                return filtered;
            }
            
            // Filter by class ID only (show all students from this class regardless of school)
            if (!schoolId && classId) {
                console.log(`Filtrando por turma ID=${classId}, verificando...`);
                
                const filtered = students.filter(student => ensureNumber(student.classId) === classId);
                console.log(`Filtrando apenas por turma ID=${classId}, encontrados ${filtered.length} alunos`);
                
                if (filtered.length > 0) {
                    console.log('Exemplo de aluno encontrado na filtragem por turma:');
                    console.log(filtered[0]);
                }
                
                return filtered;
            }
            
            // Filter by both school ID and class ID
            const filtered = students.filter(student => 
                ensureNumber(student.schoolId) === schoolId && 
                ensureNumber(student.classId) === classId
            );
            console.log(`Filtrando por escola ID=${schoolId} E turma ID=${classId}, encontrados ${filtered.length} alunos`);
            return filtered;
        }
        
        // Updated function to get classes for a specific school
        function getClasses(schoolId = null) {
            const allClasses = JSON.parse(localStorage.getItem('classes')) || [];
            
            if (!schoolId) {
                return allClasses;
            }
            
            return allClasses.filter(cls => cls.schoolId === schoolId);
        }
        
        // Função para criar um aluno via API
        async function createStudentAPI(nome, matricula, data_nascimento, escola_id, turma_id) {
            try {
                // Mostrar indicador de carregamento ou desabilitar o botão
                const saveBtn = document.querySelector('#addStudentForm button[type="submit"]');
                const originalBtnText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Salvando...';
                saveBtn.disabled = true;
                
                // Preparar dados para envio
                const studentData = {
                    nome: nome,
                    matricula: parseInt(matricula, 10), // API espera um número, não uma string
                    data_nascimento: data_nascimento || null,
                    escola_id: escola_id,
                    turma_id: turma_id
                };
                
                console.log('Enviando dados de aluno para API:', studentData);
                
                // Enviar para a API
                const response = await fetch('https://sag-sag.rak8a3.easypanel.host/api/alunos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(studentData)
                });
                
                // Restaurar o botão
                saveBtn.innerHTML = originalBtnText;
                saveBtn.disabled = false;
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro ao criar aluno. Status: ${response.status}. Detalhes: ${errorText}`);
                }
                
                // Processar a resposta
                const data = await response.json();
                console.log('Aluno criado com sucesso na API:', data);
                
                // Adicionar ao armazenamento local
                const newStudent = addStudent(
                    nome,
                    matricula,
                    data_nascimento,
                    escola_id,
                    turma_id,
                    data.id // ID retornado pela API
                );
                
                // Fechar o modal
                document.getElementById('addStudentModal').classList.add('hidden');
                
                // Limpar o formulário
                document.getElementById('addStudentForm').reset();
                
                // Atualizar a lista de alunos
                renderStudentsList();
                
                // Mostrar mensagem de sucesso
                alert('Aluno cadastrado com sucesso!');
                
                return data;
            } catch (error) {
                console.error('Erro ao criar aluno:', error);
                alert(`Erro ao criar aluno: ${error.message}`);
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Atualizar nome do usuário
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name;
            }
            
            // Inicializar a lista de alunos no localStorage se não existir
            if (!localStorage.getItem('students')) {
                localStorage.setItem('students', JSON.stringify([]));
            }
            
            // Carregar alunos da API
            loadStudentsFromAPI();
            
            // Preencher seletores de escolas e turmas
            populateFilters();
            
            // Renderizar lista de alunos
            renderStudentsList();
            
            // Eventos dos modais
            const addStudentBtn = document.getElementById('addStudentBtn');
            const addStudentModal = document.getElementById('addStudentModal');
            const closeStudentModal = document.getElementById('closeStudentModal');
            const cancelStudentBtn = document.getElementById('cancelStudentBtn');
            const addStudentForm = document.getElementById('addStudentForm');
            
            addStudentBtn.addEventListener('click', function() {
                populateSchoolSelector();
                addStudentModal.classList.remove('hidden');
            });
            
            closeStudentModal.addEventListener('click', function() {
                addStudentModal.classList.add('hidden');
            });
            
            cancelStudentBtn.addEventListener('click', function() {
                addStudentModal.classList.add('hidden');
            });
            
            // Filtro por escola e turma
            document.getElementById('filterSchool').addEventListener('change', function() {
                const schoolId = ensureNumber(this.value);
                
                // Resetar o filtro de turma quando a escola mudar
                const filterClassSelect = document.getElementById('filterClass');
                filterClassSelect.innerHTML = '<option value="">Todas as turmas</option>';
                
                // Se uma escola foi selecionada, popular o seletor de turmas com as turmas dessa escola
                if (schoolId) {
                    // Obter apenas as turmas da escola selecionada
                    const schoolClasses = getClasses(schoolId);
                    
                    // Popular o seletor de turmas
                    schoolClasses.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.id;
                        option.textContent = cls.name;
                        filterClassSelect.appendChild(option);
                    });
                } else {
                    // Se nenhuma escola foi selecionada, mostrar todas as turmas
                    const allClasses = getClasses();
                    const schools = getSchools();
                    
                    allClasses.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.id;
                        
                        // Adicionar informação da escola no nome da turma para clareza
                        const school = schools.find(s => s.id === ensureNumber(cls.schoolId));
                        const schoolName = school ? school.name : 'Escola desconhecida';
                        
                        // Formatar como "Turma (Escola)" para facilitar identificação
                        option.textContent = `${cls.name} (${schoolName})`;
                        
                        filterClassSelect.appendChild(option);
                    });
                }
                
                // Atualizar a lista de alunos com o novo filtro
                renderStudentsList();
            });
            
            document.getElementById('filterClass').addEventListener('change', function() {
                const classId = ensureNumber(this.value);
                const schoolId = ensureNumber(document.getElementById('filterSchool').value);
                
                console.log(`Filtro de turma alterado: Turma ID=${classId || 'nenhuma'}, Escola ID=${schoolId || 'nenhuma'}`);
                
                // Atualizar a lista de alunos com os filtros aplicados
                renderStudentsList();
            });
            
            // Atualizar seletor de turmas quando escola for selecionada no formulário
            document.getElementById('studentSchool').addEventListener('change', function() {
                const schoolId = this.value ? parseInt(this.value) : null;
                populateClassSelector(document.getElementById('studentClass'), schoolId);
            });
            
            addStudentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const nome = document.getElementById('studentName').value;
                const matricula = document.getElementById('studentRegistration').value;
                const escola_id = parseInt(document.getElementById('studentSchool').value);
                const turma_id = parseInt(document.getElementById('studentClass').value);
                
                // Validar matrícula como número
                if (!matricula || isNaN(parseInt(matricula, 10))) {
                    alert('A matrícula deve ser um número válido.');
                    return;
                }
                
                // Validar formato da matrícula para API
                const matriculaNum = parseInt(matricula, 10);
                if (matriculaNum <= 0) {
                    alert('A matrícula deve ser um número positivo.');
                    return;
                }
                
                if (nome.trim() !== '' && matricula.trim() !== '' && escola_id && turma_id) {
                    // Chamar a API para criar o aluno
                    createStudentAPI(nome, matricula, null, escola_id, turma_id);
                } else {
                    alert('Por favor, preencha todos os campos obrigatórios.');
                }
            });
            
            // Add event listener for pagination rendered event
            document.addEventListener('paginationRendered', function(e) {
                if (e.detail.selector === '#studentsList') {
                    console.log('Paginação de alunos renderizada, reattaching event handlers');
                    
                    // Reattach event handlers to edit and delete buttons
                    setTimeout(() => {
                        document.querySelectorAll('.editStudent').forEach(button => {
                            button.addEventListener('click', function() {
                                const studentId = parseInt(this.getAttribute('data-id'));
                                openEditStudentModal(studentId);
                            });
                        });
                        
                        document.querySelectorAll('.deleteStudent').forEach(button => {
                            button.addEventListener('click', function() {
                                const studentId = parseInt(this.getAttribute('data-id'));
                                deleteStudent(studentId);
                            });
                        });
                    }, 50);
                }
            });
        });
        
        // Função para preencher os seletores de filtros
        function populateFilters() {
            // Preencher o seletor de escolas
            populateSchoolSelector(document.getElementById('filterSchool'));
            
            // Preencher o seletor de turmas com todas as turmas inicialmente
            populateClassSelector(document.getElementById('filterClass'), null);
        }
        
        // Função para preencher o seletor de escolas
        function populateSchoolSelector(selector = document.getElementById('studentSchool')) {
            const schools = getSchools();
            
            // Limpar opções existentes
            selector.innerHTML = selector === document.getElementById('filterSchool') ? 
                '<option value="">Todas as escolas</option>' : 
                '<option value="">Selecione uma escola</option>';
            
            schools.forEach(school => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.name;
                selector.appendChild(option);
            });
        }
        
        // Função para preencher o seletor de turmas
        function populateClassSelector(selector = document.getElementById('studentClass'), schoolId = null) {
            // Determinar se estamos no seletor de filtro ou no seletor do formulário
            const isFilterSelector = selector === document.getElementById('filterClass');
            
            // Definir placeholder apropriado
            selector.innerHTML = isFilterSelector ? 
                '<option value="">Todas as turmas</option>' : 
                '<option value="">Selecione uma turma</option>';
            
            // Se não houver escola selecionada e for o filtro, mostrar todas as turmas
            if (!schoolId && isFilterSelector) {
                const allClasses = getClasses();
                const schools = getSchools();
                
                allClasses.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    
                    // Adicionar informação da escola no nome da turma para clareza
                    const school = schools.find(s => s.id === cls.schoolId);
                    const schoolName = school ? school.name : 'Escola desconhecida';
                    
                    // Formatar como "Turma (Escola)" para facilitar identificação
                    option.textContent = `${cls.name} (${schoolName})`;
                    
                    selector.appendChild(option);
                });
                return;
            }
            
            // Se não houver escola selecionada e for o formulário, não fazer nada
            if (!schoolId) return;
            
            // Obter turmas da escola selecionada
            const classes = getClasses(schoolId);
            console.log(`Carregando ${classes.length} turmas para a escola ID ${schoolId}`);
            
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                selector.appendChild(option);
            });
        }
        
        // Variable to store the pagination controller
        let studentsPagination = null;

        // Modified function to render students list with pagination
        function renderStudentsList() {
            const studentsList = document.getElementById('studentsList');
            const filterSchoolId = ensureNumber(document.getElementById('filterSchool').value);
            const filterClassId = ensureNumber(document.getElementById('filterClass').value);
            
            console.log("Aplicando filtros - Escola: " + (filterSchoolId || "nenhuma") + ", Turma: " + (filterClassId || "nenhuma"));
            
            // Adicionar um banner informativo sobre os filtros aplicados
            const filterBanner = document.getElementById('filterBanner') || document.createElement('div');
            filterBanner.id = 'filterBanner';
            filterBanner.className = 'bg-blue-50 border-l-4 border-blue-500 p-4 mb-4';
            
            let students;
            let filterMessage = "";
            
            // Obter a lista filtrada de alunos com base nos filtros selecionados
            if (filterSchoolId && filterClassId) {
                // Filtrar por escola e turma
                students = getStudents(filterSchoolId, filterClassId);
                
                // Obter nomes para a mensagem
                const escola = getSchools().find(s => s.id === filterSchoolId);
                const turma = getClasses().find(c => c.id === filterClassId);
                filterMessage = "<strong>Filtros aplicados:</strong> Escola \"" + (escola?.name || "Desconhecida") + 
                                "\" + Turma \"" + (turma?.name || "Desconhecida") + "\" (" + students.length + " alunos)";
                
            } else if (filterSchoolId) {
                // Filtrar apenas por escola
                students = getStudents(filterSchoolId);
                
                // Obter nome da escola para a mensagem
                const escola = getSchools().find(s => s.id === filterSchoolId);
                filterMessage = "<strong>Filtro aplicado:</strong> Escola \"" + (escola?.name || "Desconhecida") + 
                                "\" (" + students.length + " alunos)";
                
            } else if (filterClassId) {
                // Filtrar apenas por turma
                students = getStudents(null, filterClassId);
                
                // Obter nome da turma para a mensagem
                const turma = getClasses().find(c => c.id === filterClassId);
                const turmaName = turma?.name || 'Desconhecida';
                let escolaName = 'Desconhecida';
                
                if (turma && turma.schoolId) {
                    const escola = getSchools().find(s => s.id === ensureNumber(turma.schoolId));
                    if (escola) {
                        escolaName = escola.name;
                    }
                }
                
                filterMessage = "<strong>Filtro aplicado:</strong> Turma \"" + turmaName + 
                                "\" da escola \"" + escolaName + "\" (" + students.length + " alunos)";
                
            } else {
                // Sem filtros aplicados
                students = getStudents();
                filterMessage = "<strong>Sem filtros aplicados</strong> - Mostrando todos os " + students.length + " alunos";
            }
            
            console.log("Total de alunos após filtro: " + students.length);
            
            // Atualizar o banner informativo
            filterBanner.innerHTML = filterMessage;
            
            // Adicionar o banner antes da lista de alunos se ainda não existir
            const studentsListContainer = studentsList.parentElement;
            if (!document.getElementById('filterBanner')) {
                studentsListContainer.insertBefore(filterBanner, studentsList);
            }
            
            // Se não houver alunos, mostrar mensagem e esconder paginação
            if (students.length === 0) {
                studentsList.innerHTML = '<li class="px-4 py-4 sm:px-6 text-center text-gray-500">' +
                    '<i class="fas fa-search text-xl mb-2"></i><br>' +
                    'Nenhum aluno encontrado para os filtros selecionados</li>';
                document.getElementById('studentsPaginationControls').classList.add('hidden');
                return;
            }
            
            // Mostrar os controles de paginação
            document.getElementById('studentsPaginationControls').classList.remove('hidden');
            
            // Limpar a lista atual e a paginação
            studentsList.innerHTML = '';
            document.getElementById('studentsPaginationContainer').innerHTML = '';
            
            // Destruir o controlador anterior se existir
            if (studentsPagination) {
                console.log("Recriando controlador de paginação para exibir " + students.length + " alunos filtrados");
            }
            
            // Sempre criar um novo controlador de paginação com os alunos filtrados
            studentsPagination = null;
            
            // Inicializar a paginação com os alunos filtrados
            initStudentsPagination(students);
        }
        
        // Function to initialize pagination for students
        function initStudentsPagination(students) {
            console.log(`Inicializando paginação com ${students.length} alunos`);
            
            // Verificar primeiros 3 alunos para diagnóstico
            if (students.length > 0) {
                students.slice(0, Math.min(3, students.length)).forEach((student, index) => {
                    console.log(`Aluno ${index} na paginação: ID=${student.id}, Nome=${student.name}, Turma=${student.classId}`);
                    
                    // Verificar se a turma existe
                    const turma = getClasses().find(c => c.id === ensureNumber(student.classId));
                    console.log(`Turma do aluno ${index}: ${turma ? turma.name : 'Não encontrada'}`);
                });
            }
            
            // Recriamos completamente o controlador de paginação a cada filtro
            if (studentsPagination) {
                console.log('Recriando controlador de paginação existente');
            }
            
            studentsPagination = createPagination({
                data: students,
                itemsPerPage: 10,
                renderItemCallback: (container, student, startIndex) => {
                    const school = getSchools().find(s => s.id === student.schoolId);
                    const schoolName = school ? school.name : 'Escola não encontrada';
                    
                    const cls = getClasses().find(c => c.id === student.classId);
                    const className = cls ? cls.name : 'Turma não encontrada';
                    
                    const li = document.createElement('li');
                    li.className = 'block hover:bg-gray-50';
                    li.innerHTML = `
                        <div class="flex items-center px-4 py-4 sm:px-6">
                            <div class="min-w-0 flex-1 flex items-center">
                                <div class="flex-shrink-0">
                                    <span class="h-12 w-12 rounded-full bg-purple-100 flex items-center justify-center">
                                        <i class="fas fa-user-graduate text-purple-600 text-lg"></i>
                                    </span>
                                </div>
                                <div class="min-w-0 flex-1 px-4">
                                    <div>
                                        <p class="text-sm font-medium text-blue-600 truncate">${student.name}</p>
                                        <p class="mt-1 flex flex-wrap gap-2">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                <i class="fas fa-id-card mr-1"></i> ${student.registration}
                                            </span>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-school mr-1"></i> ${schoolName}
                                            </span>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                                <i class="fas fa-users mr-1"></i> ${className}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button class="text-indigo-600 hover:text-indigo-900 editStudent" data-id="${student.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="ml-4 text-red-600 hover:text-red-900 deleteStudent" data-id="${student.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(li);
                },
                containerSelector: '#studentsList',
                paginationContainerSelector: '#studentsPaginationContainer',
                emptyCallback: (container) => {
                    container.innerHTML = `
                        <li class="px-4 py-4 sm:px-6 text-center text-gray-500">
                            Nenhum aluno encontrado para os filtros selecionados
                        </li>`;
                },
                countElements: {
                    start: document.getElementById('studentsStartItem'),
                    end: document.getElementById('studentsEndItem'),
                    total: document.getElementById('studentsTotalItems')
                },
                prevBtnSelector: '#studentsPrevPage',
                nextBtnSelector: '#studentsNextPage',
                prevBtnMobileSelector: '#studentsPrevPageMobile',
                nextBtnMobileSelector: '#studentsNextPageMobile'
            });
            
            // Render the pagination
            studentsPagination.render();
            
            // Add event handlers for the edit and delete buttons
            document.querySelectorAll('.editStudent').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = parseInt(this.getAttribute('data-id'));
                    openEditStudentModal(studentId);
                });
            });
            
            document.querySelectorAll('.deleteStudent').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = parseInt(this.getAttribute('data-id'));
                    deleteStudent(studentId);
                });
            });
        }

        // Função para carregar alunos da API
        async function loadStudentsFromAPI() {
            try {
                console.log('Carregando alunos da API...');
                
                // Mostrar indicador de carregamento
                document.getElementById('studentsList').innerHTML = `
                    <li class="px-4 py-4 sm:px-6 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i> Carregando alunos da API...
                    </li>`;
                
                const response = await fetch('https://sag-sag.rak8a3.easypanel.host/api/alunos', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Alunos carregados com sucesso:', data);
                    
                    // Verificar se a resposta é um array
                    if (Array.isArray(data)) {
                        // Limpar alunos existentes e adicionar os novos
                        localStorage.setItem('students', JSON.stringify([]));
                        
                        // Se a API retornou dados, usá-los
                        if (data.length > 0) {
                        data.forEach(aluno => {
                            addStudent(
                                aluno.nome,
                                aluno.matricula,
                                aluno.data_nascimento,
                                aluno.escola_id,
                                aluno.turma_id,
                                aluno.id
                            );
                        });
                            
                            console.log('Carregados ' + data.length + ' alunos da API');
                        } else {
                            // Caso a API não tenha retornado alunos, criar alguns exemplos
                            console.log('Nenhum aluno retornado da API. Criando exemplos...');
                            createSampleStudents();
                        }
                        
                        // Atualizar a interface
                        renderStudentsList();
                    } else {
                        console.error('Resposta da API não é um array:', data);
                        createSampleStudents();
                        renderStudentsList();
                    }
                } else {
                    console.error('Erro ao carregar alunos da API:', response.status);
                    createSampleStudents();
                    renderStudentsList();
                }
            } catch (error) {
                console.error('Erro ao carregar alunos da API:', error);
                createSampleStudents();
                    renderStudentsList();
            }
        }
        
        // Função para criar alunos de exemplo quando a API falha
        function createSampleStudents() {
            // Primeiro vamos verificar se já temos escolas e turmas
            let schools = getSchools();
            let classes = getClasses();
            
            // Se não houver escolas, criar algumas
            if (schools.length === 0) {
                console.log('Criando escolas de exemplo...');
                
                // Criar escola exemplo
                const escola1 = { id: 1, name: 'Escola Municipal João Silva', region: 'Leste', group: 'Municipal' };
                const escola2 = { id: 2, name: 'Escola Estadual Maria Souza', region: 'Centro', group: 'Estadual' };
                
                schools = [escola1, escola2];
                localStorage.setItem('schools', JSON.stringify(schools));
            }
            
            // Se não houver turmas, criar algumas
            if (classes.length === 0) {
                console.log('Criando turmas de exemplo...');
                
                // Criar turmas exemplo
                const turma1 = { id: 1, name: '1º Ano - Manhã', series: '1', schoolId: 1, shift: 'Manhã' };
                const turma2 = { id: 2, name: '2º Ano - Tarde', series: '2', schoolId: 1, shift: 'Tarde' };
                const turma3 = { id: 3, name: '3º Ano - Manhã', series: '3', schoolId: 2, shift: 'Manhã' };
                
                classes = [turma1, turma2, turma3];
                localStorage.setItem('classes', JSON.stringify(classes));
            }
            
            // Verificar se já existem alunos
            const existingStudents = JSON.parse(localStorage.getItem('students')) || [];
            
            if (existingStudents.length === 0) {
                console.log('Criando alunos de exemplo...');
                
                // Lista de nomes para criar alunos aleatórios
                const nomes = ['Ana Silva', 'João Oliveira', 'Maria Santos', 'Pedro Costa', 'Carla Pereira', 
                              'Lucas Ferreira', 'Juliana Rodrigues', 'Mateus Almeida', 'Beatriz Lima', 'Gabriel Souza'];
                
                // Criar 10 alunos de exemplo
                nomes.forEach((nome, index) => {
                    // Distribuir os alunos entre as escolas e turmas disponíveis
                    const schoolId = schools[index % schools.length].id;
                    
                    // Obter turmas da escola atual
                    const schoolClasses = classes.filter(cls => cls.schoolId === schoolId);
                    const classId = schoolClasses[index % schoolClasses.length].id;
                    
                    // Criar matrícula como número aleatório 6 dígitos
                    const matricula = Math.floor(100000 + Math.random() * 900000).toString();
                    
                    // Adicionar aluno
                    addStudent(
                        nome,
                        matricula,
                        null, // data de nascimento
                        schoolId,
                        classId,
                        index + 1 // ID fictício da API
                    );
                });
                
                console.log('Criados 10 alunos de exemplo');
            }
        }

        // Função para adicionar um aluno
        function addStudent(name, registration, birthdate, schoolId, classId, apiId = null) {
            let students = JSON.parse(localStorage.getItem('students')) || [];
            const newId = students.length > 0 ? Math.max(...students.map(s => s.id)) + 1 : 1;
            
            // Garantir que a matrícula seja uma string
            const regStr = registration ? registration.toString() : "";
            
            const newStudent = {
                id: newId,
                name: name,
                registration: regStr,
                birthdate: birthdate,
                schoolId: schoolId,
                classId: classId,
                apiId: apiId // Armazenar o ID da API se fornecido
            };
            
            students.push(newStudent);
            localStorage.setItem('students', JSON.stringify(students));
            return newStudent;
        }

        // Função para obter as escolas do localStorage
        function getSchools() {
            return JSON.parse(localStorage.getItem('schools')) || [];
        }

        // Função para excluir um aluno
        async function deleteStudent(studentId) {
            if (!confirm('Tem certeza que deseja excluir este aluno?')) {
                return;
            }
            
            try {
                // Obter informações do aluno
                const students = JSON.parse(localStorage.getItem('students')) || [];
                const studentIndex = students.findIndex(s => s.id === studentId);
                
                if (studentIndex === -1) {
                    alert('Aluno não encontrado. A lista será atualizada.');
                    renderStudentsList();
                    return;
                }
                
                const student = students[studentIndex];
                
                // Se temos um ID da API, excluir via API
                if (student.apiId) {
                    console.log(`Tentando excluir aluno com ID da API: ${student.apiId}`);
                    
                    try {
                        const response = await fetch(`https://sag-sag.rak8a3.easypanel.host/api/alunos/${student.apiId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.text();
                            console.error(`Erro ao excluir aluno da API: ${errorData}`);
                            alert(`Erro ao excluir aluno da API. O aluno será removido apenas localmente.`);
                        } else {
                            console.log('Aluno excluído com sucesso da API');
                        }
                    } catch (apiError) {
                        console.error('Erro ao acessar API para exclusão:', apiError);
                        alert(`Erro ao acessar API: ${apiError.message}. O aluno será removido apenas localmente.`);
                    }
                }
                
                // Remover o aluno do localStorage de qualquer forma
                students.splice(studentIndex, 1);
                localStorage.setItem('students', JSON.stringify(students));
                
                // Atualizar a lista de alunos
                alert('Aluno excluído com sucesso!');
                renderStudentsList();
                
            } catch (error) {
                console.error('Erro ao excluir aluno:', error);
                alert('Ocorreu um erro ao excluir o aluno. Por favor, tente novamente.');
            }
        }
        
        // Função para abrir o modal de edição de aluno
        function openEditStudentModal(studentId) {
            alert('Funcionalidade de edição a ser implementada.');
            // Implementação pendente
        }
    </script>
</body>
</html>